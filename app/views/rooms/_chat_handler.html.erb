<script type="text/javascript">
  window.api_v1_messages_url = "<%= api_v1_messages_url %>"
</script>

<%= coffee_script_tag do %>
  class @ChatHandler
    @getMessages: (room_id) ->
      $.getJSON("#{api_v1_messages_url}?room_id=#{room_id}", ChatHandler.renderMessages)

    @renderMessages: (messages) =>
      for message in messages
        ChatHandler.addMessage(message)

    @handleMessage: (data) =>
      if (data.chat_message.message_type == "Message")
        ChatHandler.addMessage(data.chat_message)
      else
        ChatHandler.addEvent(data.chat_message)

    @addMessage: (message) =>
      mustache_message = Mustache.to_html($('#message_template').html(), message)
      $('#messages').append ChatHandler.replaceLinks(mustache_message)

    @addEvent: (message) =>
      $('#messages').append Mustache.to_html($('#event_template').html(), message)

    @replaceLinks: (content) ->
      images = content.match /http[s]?:\/\/(?:[a-z\-\d]+\.)+\S+\.(?:jpg|gif|png)(?:\?.*)?/ig
      if images
        ChatHandler.replaceImages(images, content)
      else
        linkify(content)
      
    @replaceImages: (images, content) ->
      for image in images
        content = content.replace image, ""
      content = linkify(content)
      for image in images
        content = content + "<a href='#{image}' target='_blank'><img src='#{image}' height=200</img></a>"
      content

<% end %>