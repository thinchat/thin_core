<%= coffee_script_tag do %>
  window.faye_url = '<%= FAYE_URL %>'
  window.user     = '<%= current_user.user_json.html_safe %>'
  window.room_id  = '<%= @room.id %>'

  class ChatHandler
    @getMessages: (room_id) ->
      $.getJSON("http://localhost:3000/api/v1/messages?room_id=#{room_id}", ChatHandler.renderMessages)

    @renderMessages: (messages) =>
      for message in messages
        ChatHandler.addOneMessage(message)

    @addMessage: (data) =>
      if (data.chat_message.message_type == "Message")
        ChatHandler.addOneMessage(data.chat_message)
      else
        ChatHandler.addOneEvent(data.chat_message)

    @addOneMessage: (message) =>
      $('#messages').append Mustache.to_html($('#message_template').html(), message)

    @addOneEvent: (message) =>
      $('#messages').append Mustache.to_html($('#event_template').html(), message)

  class FayeHandler
    constructor: (faye_url) ->
      @client = new Faye.Client(faye_url + '/faye')

    subscribe: (room_id) =>
      @client.subscribe("/messages/#{room_id}", (data) ->
        console.log(data)
        ChatHandler.addMessage(data)
      )

    addExtensions: (room_id) =>
      @client.addExtension outgoing: (message, callback) ->
        if message.channel is "/meta/subscribe"
          message.data = message.data or $.namespace.getUser(room_id)
          console.log message
        callback message

  class Heartbeat
    @pulse: (client, user) ->
      client.publish('/heart_beat', user)
      setTimeout((-> Heartbeat.pulse(client, user)), 10000)


  jQuery ->
    chatHandler = ChatHandler.getMessages(room_id)
    faye = new FayeHandler(faye_url)
    faye.subscribe(room_id)
    faye.addExtensions(room_id)
    heartbeat = Heartbeat.pulse(faye.client, $.namespace.getUser(room_id))

    $("#new_message").live("ajax:complete", (event,xhr,status) ->
      $('#new_message')[0].reset())
<% end %>
